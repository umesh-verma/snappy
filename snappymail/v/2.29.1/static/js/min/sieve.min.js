!function(){"use strict";const t=rl.i18n,e=(t,e)=>Object.values(t).forEach(e),s=(t,e)=>Object.entries(t).forEach((([t,s])=>e(t,s))),r=t=>((t=ko.observableArray(t)).subscribe((t=>t.forEach((t=>"deleted"===t.status&&null==t.moved&&t.value.onDestroy?.()))),t,"arrayChange"),t),i=t=>ko.computed(t,{pure:!0}),a=(t,e)=>t.map((t=>t.toString?.()||t)).join(e),n=t=>"ERROR "+t,o=rl.app.Remote,m=ko.observableArray(),h=r(),l=ko.observable(!1),c=ko.observable(!1),u=ko.observable(""),d=t=>{c(!0),u(t)},p=(t=1)=>{let e=[":is",":contains",":matches"];return!m.includes("extlists")&&t||e.push(":list"),e};function g(t,e){if(null!=t)switch(typeof t){case"boolean":return 0!=e&&!!e;case"number":return isFinite(e)?parseFloat(e):0;case"string":return null!=e?""+e:"";case"object":if(t.constructor.reviveFromJson)return t.constructor.reviveFromJson(e);if(Array.isArray(t)&&!Array.isArray(e))return[]}return e}class AbstractModel{constructor(){this.disposables=[]}addObservables(t){s(t,((t,e)=>this[t]||(this[t]=ko.observable(e))))}addComputables(t){s(t,((t,e)=>this[t]=i(e)))}addSubscribables(t){s(t,((t,e)=>this.disposables.push(this[t].subscribe(e))))}onDestroy(){this.disposables.forEach((t=>{"function"==typeof t?.dispose&&t.dispose()})),e(this,(t=>{(ko.isObservableArray(t)?t():t)?.onDestroy?.()}))}static validJson(t){return!(!t||"Object/"+this.name.replace("Model","")!==t["@Object"])}static reviveFromJson(t){let e=this.validJson(t)?new this:null;return e?.revivePropertiesFromJson(t),e}revivePropertiesFromJson(t){const e=this.constructor.validJson(t);return e&&s(t,((t,e)=>{if("@"!==t[0])try{switch(typeof this[t=t[0].toLowerCase()+t.slice(1)]){case"function":ko.isObservable(this[t])&&this[t](g(this[t](),e));break;case"boolean":case"number":case"object":case"string":this[t]=g(this[t],e)}}catch(t){}})),e}}const v="From",f="Recipient",_="Subject",S="Header",b="Body",y="Size",C="Contains",T="NotContains",w="EqualTo",x="NotEqualTo",E="Regex",G="Over",A="Under",k="Text",F="Raw";class FilterConditionModel extends AbstractModel{constructor(){super(),this.addObservables({field:v,type:C,value:"",valueError:!1,valueSecond:"",valueSecondError:!1}),this.template=i((()=>{const t="SettingsFiltersCondition";switch(this.field()){case b:return t+"Body";case y:return t+"Size";case S:return t+"More";default:return t+"Default"}})),this.addSubscribables({field:()=>{this.value(""),this.valueSecond("")}})}verify(){return this.value()?!(S===this.field()&&!this.valueSecond())||(this.valueSecondError(!0),!1):(this.valueError(!0),!1)}toJSON(){return{Field:this.field,Type:this.type,Value:this.value,ValueSecond:this.valueSecond}}cloneSelf(){const t=new FilterConditionModel;return t.field(this.field()),t.type(this.type()),t.value(this.value()),t.valueSecond(this.valueSecond()),t}}const O={None:"None",MoveTo:"MoveTo",Discard:"Discard",Vacation:"Vacation",Reject:"Reject",Forward:"Forward"},L="Any";class FilterModel extends AbstractModel{constructor(){super(),this.id="",this.addObservables({enabled:!0,askDelete:!1,canBeDeleted:!0,name:"",nameError:!1,conditionsType:L,actionValue:"",actionValueError:!1,actionValueSecond:"",actionValueThird:"",actionValueFourth:"",actionValueFourthError:!1,markAsRead:!1,keep:!0,stop:!0,actionType:O.MoveTo}),this.conditions=r();this.addComputables({nameSub:()=>{let t="";const e=this.actionValue(),s="SETTINGS_FILTERS/SUBNAME_";switch(this.actionType()){case O.MoveTo:t=rl.i18n(s+"MOVE_TO",{FOLDER:e});break;case O.Forward:t=rl.i18n(s+"FORWARD_TO",{EMAIL:e});break;case O.Vacation:t=rl.i18n(s+"VACATION_MESSAGE");break;case O.Reject:t=rl.i18n(s+"REJECT");break;case O.Discard:t=rl.i18n(s+"DISCARD")}return t?"("+t+")":""},actionTemplate:()=>{const t="SettingsFiltersAction";switch(this.actionType()){case O.Forward:return t+"Forward";case O.Vacation:return t+"Vacation";case O.Reject:return t+"Reject";case O.None:return t+"None";case O.Discard:return t+"Discard";case O.MoveTo:default:return t+"MoveToFolder"}}}),this.addSubscribables({name:t=>this.nameError(!t),actionValue:t=>this.actionValueError(!t),actionType:()=>{this.actionValue(""),this.actionValueError(!1),this.actionValueSecond(""),this.actionValueThird(""),this.actionValueFourth(""),this.actionValueFourthError(!1)}})}generateID(){this.id=Jua.randomId()}verify(){return this.name()?(!this.conditions.length||!this.conditions.find((t=>t&&!t.verify())))&&(!this.actionValue()&&[O.MoveTo,O.Forward,O.Reject,O.Vacation].includes(this.actionType())?(this.actionValueError(!0),!1):O.Forward!==this.actionType()||this.actionValue().includes("@")?O.Vacation===this.actionType()&&this.actionValueFourth()&&!this.actionValueFourth().includes("@")?(this.actionValueFourthError(!0),!1):(this.nameError(!1),this.actionValueError(!1),!0):(this.actionValueError(!0),!1)):(this.nameError(!0),!1)}toJSON(){return{ID:this.id,Enabled:this.enabled()?1:0,Name:this.name,Conditions:this.conditions,ConditionsType:this.conditionsType,ActionType:this.actionType(),ActionValue:this.actionValue,ActionValueSecond:this.actionValueSecond,ActionValueThird:this.actionValueThird,ActionValueFourth:this.actionValueFourth,Keep:this.keep()?1:0,Stop:this.stop()?1:0,MarkAsRead:this.markAsRead()?1:0}}addCondition(){this.conditions.push(new FilterConditionModel)}removeCondition(t){this.conditions.remove(t)}static reviveFromJson(t){t.id=t.ID,delete t.ID;const e=super.reviveFromJson(t);return e&&(e.id=""+(e.id||""),e.conditions((t.Conditions||[]).map((t=>FilterConditionModel.reviveFromJson(t))).filter((t=>t)))),e}assignTo(t){const e=t||new FilterModel;return e.id=this.id,e.enabled(this.enabled()),e.name(this.name()),e.nameError(this.nameError()),e.conditionsType(this.conditionsType()),e.markAsRead(this.markAsRead()),e.actionType(this.actionType()),e.actionValue(this.actionValue()),e.actionValueError(this.actionValueError()),e.actionValueSecond(this.actionValueSecond()),e.actionValueThird(this.actionValueThird()),e.actionValueFourth(this.actionValueFourth()),e.keep(this.keep()),e.stop(this.stop()),e.conditions(this.conditions.map((t=>t.cloneSelf()))),e}}const V="rainloop.user";function R(t){let e,s,r=/BEGIN:HEADER([\s\S]+?)END:HEADER/gm,i=[];if(t.length&&t.includes("RAINLOOP:SIEVE"))for(;e=r.exec(t);)e=decodeURIComponent(escape(atob(e[1].replace(/\s+/g,"")))),e&&e.length&&(e=JSON.parse(e))&&(e["@Object"]="Object/Filter",e.Conditions.forEach((t=>t["@Object"]="Object/FilterCondition")),s=FilterModel.reviveFromJson(e),s&&i.push(s));return i}class SieveScriptModel extends AbstractModel{constructor(){super(),this.addObservables({name:"",active:!1,body:"",exists:!1,nameError:!1,askDelete:!1,canBeDeleted:!0,hasChanges:!1}),this.filters=r(),this.addSubscribables({name:()=>this.hasChanges(!0),filters:()=>this.hasChanges(!0),body:()=>this.hasChanges(!0)})}filtersToRaw(){return function(t){let e="\r\n",s=/.{0,74}/g,r={},i=["# This is SnappyMail sieve script.","# Please don't change anything here.","# RAINLOOP:SIEVE",""];const a=t=>'"'+t.trim().replace(/(\\|")/g,"\\$1")+'"',n=t=>t.replace(/\s+/," ").trim(),o=(t,e)=>{let s="",r=t.type(),i=t.field(),o=t.value().trim(),m=t.valueSecond().trim();if(o.length&&("Header"!==i||m.length)){switch(r){case"NotEqualTo":s+="not ",r=":is";break;case"EqualTo":r=":is";break;case"NotContains":s+="not ",r=":contains";break;case"Text":case"Raw":case"Over":case"Under":case"Contains":r=":"+r.toLowerCase();break;case"Regex":r=":regex",e.regex=1;break;default:return"/* @Error: unknown type value "+r+"*/ false"}switch(i){case"From":s+="header "+r+' ["From"]';break;case"Recipient":s+="header "+r+' ["To", "CC"]';break;case"Subject":s+="header "+r+' ["Subject"]';break;case"Header":s+="header "+r+" ["+a(m)+"]";break;case"Body":s+="body "+r+" :contains",e.body=1;break;case"Size":s+="size "+r;break;default:return"/* @Error: unknown field value "+i+" */ false"}return"From"!==i&&"Recipient"!==i||!o.includes(",")?s+="Size"===i?" "+o:" "+a(o):s+=" ["+o.split(",").map((t=>a(t))).join(", ").trim()+"]",n(s)}return"/* @Error: empty condition value */ false"},m=(t,s)=>{let r="    ",i=!0,m=[],h=t.conditions();const l=t=>m.push(r+"# @Error ("+t+"): empty action value");1<h.length?(m.push("Any"===t.conditionsType()?"if anyof(":"if allof("),m.push(h.map((t=>r+o(t,s))).join(",\r\n")),m.push(")")):h.length?m.push("if "+o(h[0],s)):i=!1,i?m.push("{"):r="",t.markAsRead()&&["None","MoveTo","Forward"].includes(t.actionType())&&(s.imap4flags=1,m.push(r+'addflag "\\\\Seen";'));let c=t.actionValue().trim();switch(c=c.length?a(c):0,t.actionType()){case"None":break;case"Discard":m.push(r+"discard;");break;case"Vacation":if(c){s.vacation=1;let e=1,i="",o="",h=t.actionValueSecond().trim();h.length&&(i=":subject "+a(n(h))+" "),h=(""+(t.actionValueThird()||"")).trim(),h.length&&(e=Math.max(1,parseInt(h,10))),h=(""+(t.actionValueFourth()||"")).trim(),h.length&&(h=h.split(",").map((t=>t.trim().length?a(t):"")).filter((t=>t.length)),h.length&&(o=":addresses ["+h.join(", ")+"] ")),m.push(r+"vacation :days "+e+" "+o+i+c+";")}else l("vacation");break;case"Reject":c?(s.reject=1,m.push(r+"reject "+c+";")):l("reject");break;case"Forward":c?(t.keep()&&(s.fileinto=1,m.push(r+'fileinto "INBOX";')),m.push(r+"redirect "+c+";")):l("redirect");break;case"MoveTo":c?(s.fileinto=1,m.push(r+"fileinto "+c+";")):l("fileinto")}return t.stop()&&m.push(r+"stop;"),i&&m.push("}"),m.join(e)};return t.forEach((t=>{i.push(["/*","BEGIN:FILTER:"+t.id,"BEGIN:HEADER",btoa(unescape(encodeURIComponent(JSON.stringify(t)))).match(s).join(e)+"END:HEADER","*/",t.enabled()?"":"/* @Filter is disabled ",m(t,r),t.enabled()?"":"*/","/* END:FILTER */",""].join(e))})),r=Object.keys(r),(r.length?"require "+JSON.stringify(r)+";"+e:"")+e+i.join(e)}(this.filters)}rawToFilters(){return R(this.body())}verify(){return this.nameError(!this.name().trim()),!this.nameError()}toJSON(){return{name:this.name,active:this.active,body:this.body}}allowFilters(){return V===this.name()}static reviveFromJson(t){const e=super.reviveFromJson(t);return e&&(e.allowFilters()&&e.filters(R(e.body())),e.canBeDeleted(V!==t.name),e.exists(!0),e.hasChanges(!1)),e}}const j=(t,e)=>e&&void 0!==e.disabled&&t?.classList.toggle("disabled",t.disabled=e.disabled);class FilterPopupView extends rl.pluginPopupView{constructor(){super("Filter"),this.addObservables({isNew:!0,filter:null,allowMarkAsRead:!1,selectedFolderValue:""}),this.defaultOptionsAfterRender=j,this.folderSelectList=i((()=>(()=>{const t=[{id:"",name:"",system:!1,disabled:!1}],e=rl.settings.get("sieveAllowFileintoInbox")?"":"INBOX",s=r=>{r.forEach((r=>{t.push({id:r.fullName,name:"   ".repeat(r.deep)+r.detailedName(),system:!1,disabled:!r.selectable()||e==r.fullName}),r.subFolders.length&&s(r.subFolders())}))};return s(window.Sieve.folderList()||[]),t})())),this.selectedFolderValue.subscribe((()=>this.filter().actionValueError(!1))),["actionTypeOptions","fieldOptions","typeOptions","typeOptionsSize","typeOptionsBody"].forEach((t=>this[t]=ko.observableArray())),this.populateOptions()}saveFilter(){O.MoveTo===this.filter().actionType()&&this.filter().actionValue(this.selectedFolderValue()),this.filter().verify()&&(this.fTrueCallback(),this.close())}populateOptions(){this.actionTypeOptions([]);let e=e=>t("POPUPS_FILTER/SELECT_"+e);this.fieldOptions([{id:v,name:t("GLOBAL/FROM")},{id:f,name:e("FIELD_RECIPIENTS")},{id:_,name:t("GLOBAL/SUBJECT")},{id:y,name:e("FIELD_SIZE")},{id:S,name:e("FIELD_HEADER")}]),this.typeOptions([{id:C,name:e("TYPE_CONTAINS")},{id:T,name:e("TYPE_NOT_CONTAINS")},{id:w,name:e("TYPE_EQUAL_TO")},{id:x,name:e("TYPE_NOT_EQUAL_TO")}]),m&&(this.allowMarkAsRead(m.includes("imap4flags")),m.includes("fileinto")&&(this.actionTypeOptions.push({id:O.MoveTo,name:e("ACTION_MOVE_TO")}),this.actionTypeOptions.push({id:O.Forward,name:e("ACTION_FORWARD_TO")})),m.includes("reject")&&this.actionTypeOptions.push({id:O.Reject,name:e("ACTION_REJECT")}),m.includes("vacation")&&this.actionTypeOptions.push({id:O.Vacation,name:e("ACTION_VACATION_MESSAGE")}),m.includes("body")&&this.fieldOptions.push({id:b,name:e("FIELD_BODY")}),m.includes("regex")&&this.typeOptions.push({id:E,name:"Regex"})),this.actionTypeOptions.push({id:O.Discard,name:e("ACTION_DISCARD")}),this.typeOptionsSize([{id:G,name:e("TYPE_OVER")},{id:A,name:e("TYPE_UNDER")}]),this.typeOptionsBody([{id:k,name:e("TYPE_TEXT")},{id:F,name:e("TYPE_RAW")}])}removeCondition(t){this.filter().removeCondition(t)}beforeShow(t,e,s){this.populateOptions(),this.isNew(!s),this.fTrueCallback=e,this.filter(t),this.selectedFolderValue(t.actionValue())}}const N="[^\\x00\\r\\n]",M="#"+N+"*\\r\\n",q='(?:\\r\\n|[^\\x00\\r\\n"\\\\]|\\\\\\\\|\\\\")*',I="[^\\x00\\r\\n\\.]"+N+"*\\r\\n",D="\\."+N+"+\\r\\n",Q="text:[ \\t]*(?:"+M+")?\\r\\n(?:"+I+"|"+D+")*\\.\\r\\n",z="[0-9]+[KMGkmg]?",P='"'+q+'"',J=P+"|"+Q,B="\\[\\s*(?:"+J+")(?:\\s*,\\s*(?:"+J+"))*\\s*\\]";class GrammarString{constructor(t=""){this._value=t}toString(){return this._value}get value(){return this._value}set value(t){this._value=t}get length(){return this._value.length}}class GrammarComment extends GrammarString{}class GrammarCommand{constructor(t){this.identifier=t||this.constructor.name.toLowerCase().replace(/(test|command|action)$/,""),this.arguments=[],this.commands=new GrammarCommands}toString(){let t=this.identifier;return this.arguments.length&&(t+=" "+a(this.arguments," ")),t+(this.commands.length?" "+this.commands:";")}getComparators(){return["i;ascii-casemap"]}getMatchTypes(){return[":is",":contains",":matches"]}pushArguments(t){this.arguments=t}}class GrammarCommands extends Array{toString(){return this.length?"{\r\n\t"+a(this,"\r\n\t")+"\r\n}":"{}"}push(t){(t instanceof GrammarCommand||t instanceof GrammarComment)&&super.push(t)}}class ControlCommand extends GrammarCommand{constructor(t){super(t),this.commands=new GrammarCommands}toString(){let t=this.identifier;return this.arguments.length&&(t+=" "+a(this.arguments," ")),t+(this.commands.length?" "+this.commands:";")}getComparators(){return["i;ascii-casemap"]}getMatchTypes(){return[":is",":contains",":matches"]}}class ActionCommand extends GrammarCommand{constructor(t){super(t)}toString(){let t=this.identifier;return this.arguments.length&&(t+=" "+a(this.arguments," ")),t+";"}}class TestCommand extends GrammarCommand{constructor(t){super(t),this.comparator="",this.match_type=":is"}toString(){if(!p().includes(this.match_type))throw"Unsupported match-type "+this.match_type;return(this.identifier+(this.comparator?" :comparator "+this.comparator:"")+(this.match_type?" "+this.match_type:"")+" "+a(this.arguments," ")).trim()}}class GrammarTestList extends Array{toString(){return 1<this.length?"("+this.join(", ")+")":this.length?this[0]:""}push(t){if(!(t instanceof TestCommand))throw"Not an instanceof Test";super.push(t)}}class GrammarBracketComment extends GrammarComment{toString(){return"/* "+super.toString()+" */"}}class GrammarHashComment extends GrammarComment{toString(){return"# "+super.toString()}}class GrammarNumber{constructor(t="0"){this._value=t}toString(){return this._value}get value(){return this._value}set value(t){this._value=t}}class GrammarStringList extends Array{toString(){return 1<this.length?"["+this.join(",")+"]":this.length?this[0]:""}push(t){t instanceof GrammarString||(t=new GrammarQuotedString(t)),super.push(t)}}const H=RegExp('(?:^\\s*|\\s*,\\s*)(?:"('+q+')"|text:[ \\t]*('+M+")?\\r\\n((?:"+I+"|"+D+")*)\\.\\r\\n)","gm");GrammarStringList.fromString=t=>{let e,s=new GrammarStringList;for(t=t.replace(/^[\r\n\t[]+/,"");e=H.exec(t);)e[3]?s.push(new GrammarMultiLine(e[3],e[2])):s.push(new GrammarQuotedString(e[1]));return s};class GrammarQuotedString extends GrammarString{toString(){return'"'+this._value.replace(/[\\"]/g,"\\$&")+'"'}}class GrammarMultiLine extends GrammarString{constructor(t,e=""){super(),this.value=t,this.comment=e}toString(){return"text:"+(this.comment?"# "+this.comment:"")+"\r\n"+this.value+"\r\n.\r\n"}}const U=RegExp("text:[ \\t]*("+M+")?\\r\\n((?:"+I+"|"+D+")*)\\.\\r\\n","m");GrammarMultiLine.fromString=t=>(t=t.match(U))[2]?new GrammarMultiLine(t[2].replace(/\r\n$/,""),t[1]):new GrammarMultiLine;class ConditionalCommand extends ControlCommand{constructor(){super(),this.test=null}toString(){return this.identifier+" "+this.test+" "+this.commands}}class RequireCommand extends ControlCommand{constructor(){super(),this.capabilities=new GrammarStringList}toString(){return"require "+this.capabilities+";"}pushArguments(t){t[0]instanceof GrammarStringList?this.capabilities=t[0]:t[0]instanceof GrammarQuotedString&&this.capabilities.push(t[0])}}const Y=t=>":localpart"===t||":domain"===t||":all"===t||Z(t),Z=t=>":user"===t||":detail"===t,$=t=>{if(t instanceof GrammarStringList)return t;let e=new GrammarStringList;return t instanceof GrammarString&&e.push(t.value),e};class NotTest extends TestCommand{constructor(){super(),this.test=new TestCommand}toString(){return"not "+this.test}pushArguments(){throw"No arguments"}}class FlagCommand extends ActionCommand{constructor(){super(),this._variablename=new GrammarQuotedString,this.list_of_flags=new GrammarStringList}get require(){return"imap4flags"}toString(){return this.identifier+" "+this._variablename+" "+this.list_of_flags+";"}get variablename(){return this._variablename.value}set variablename(t){this._variablename.value=t}pushArguments(t){t[1]?(t[0]instanceof GrammarQuotedString&&(this._variablename=t[0]),t[1]instanceof GrammarString&&(this.list_of_flags=t[1])):t[0]instanceof GrammarString&&(this.list_of_flags=t[0])}}class ForEveryPartCommand extends ControlCommand{constructor(){super(),this._name=new GrammarString}get require(){return"foreverypart"}toString(){let t="foreverypart";return this._subject.length&&(t+=" :name "+this._name),t+" "+this.commands}pushArguments(t){t.forEach(((e,s)=>{":name"===e&&(this._name.value=t[s+1].value)}))}}const W=(t,e)=>{const s=new t,r=s.require;return e&&!(s instanceof e)||r&&!(Array.isArray(r)?r:[r]).every((t=>m.includes(t)))?null:s.identifier},K=[class IfCommand extends ConditionalCommand{},class ElsIfCommand extends ConditionalCommand{},class ElseCommand extends ConditionalCommand{toString(){return this.identifier+" "+this.commands}},ConditionalCommand,RequireCommand,class StopCommand extends ControlCommand{},class DiscardCommand extends ActionCommand{},class FileIntoCommand extends ActionCommand{constructor(){super(),this._mailbox=new GrammarQuotedString}get require(){return"fileinto"}toString(){return"fileinto"+(this.copy&&m.includes("copy")?" :copy":"")+(this.create&&m.includes("mailbox")?" :create":"")+" "+this._mailbox+";"}get mailbox(){return this._mailbox.value}set mailbox(t){this._mailbox.value=t}pushArguments(t){t[0]instanceof GrammarString&&(this._mailbox=t[0])}},class KeepCommand extends ActionCommand{},class RedirectCommand extends ActionCommand{constructor(){super(),this._address=new GrammarQuotedString}toString(){return"redirect"+(this.copy&&m.includes("copy")?" :copy":"")+" "+this._address+";"}get address(){return this._address.value}set address(t){this._address.value=t}pushArguments(t){t[0]instanceof GrammarString&&(this._address=t[0])}},class AddressTest extends TestCommand{constructor(){super(),this.address_part=":all",this.header_list=new GrammarStringList,this.key_list=new GrammarStringList}get require(){let t=[];return Z(this.address_part)&&t.push("subaddress"),(this.last||this.index&&this.index.value)&&t.push("index"),(this.mime||this.anychild)&&t.push("mime"),t}toString(){let t="address";return m.includes("mime")&&(this.mime&&(t+=" :mime"),this.anychild&&(t+=" :anychild")),t+(this.comparator?" :comparator "+this.comparator:"")+" "+this.address_part+" "+this.match_type+" "+this.header_list+" "+this.key_list}pushArguments(t){this.key_list=$(t.pop()),this.header_list=$(t.pop()),t.forEach(((e,s)=>{Y(e)?this.address_part=e:":last"===e?this.last=!0:":mime"===e?this.mime=!0:":anychild"===e?this.anychild=!0:s&&":index"===t[s-1]&&(this.index.value=e.value)}))}},class AllOfTest extends TestCommand{constructor(){super(),this.tests=new GrammarTestList}toString(){return"allof "+this.tests}},class AnyOfTest extends TestCommand{constructor(){super(),this.tests=new GrammarTestList}toString(){return"anyof "+this.tests}},class EnvelopeTest extends TestCommand{constructor(){super(),this.address_part=":all",this.envelope_part=new GrammarStringList,this.key_list=new GrammarStringList}get require(){return Z(this.address_part)?["envelope","subaddress"]:"envelope"}toString(){return"envelope"+(this.comparator?" :comparator "+this.comparator:"")+" "+this.address_part+" "+this.match_type+" "+this.envelope_part+" "+this.key_list}pushArguments(t){this.key_list=$(t.pop()),this.envelope_part=$(t.pop()),t.forEach((t=>{Y(t)&&(this.address_part=t)}))}},class ExistsTest extends TestCommand{constructor(){super(),this.header_names=new GrammarStringList}get require(){return this.mime||this.anychild?["mime"]:null}toString(){let t="exists";return m.includes("mime")&&(this.mime&&(t+=" :mime"),this.anychild&&(t+=" :anychild")),t+" "+this.header_names}pushArguments(t){this.header_names=$(t.pop()),t.forEach((t=>{":mime"===t?this.mime=!0:":anychild"===t&&(this.anychild=!0)}))}},class FalseTest extends TestCommand{toString(){return"false"}},class HeaderTest extends TestCommand{constructor(){super(),this.address_part=":all",this.header_names=new GrammarStringList,this.key_list=new GrammarStringList,this.mime=!1,this.anychild=!1,this.type=!1,this.subtype=!1,this.contenttype=!1,this.param=new GrammarStringList}get require(){let t=[];return Z(this.address_part)&&t.push("subaddress"),(this.last||this.index&&this.index.value)&&t.push("index"),(this.mime||this.anychild)&&t.push("mime"),t}toString(){let t="header";return m.includes("mime")&&(this.mime&&(t+=" :mime",this.type&&(t+=" :type"),this.subtype&&(t+=" :subtype"),this.contenttype&&(t+=" :contenttype"),this.param.length&&(t+=" :param "+this.param)),this.anychild&&(t+=" :anychild")),t+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.header_names+" "+this.key_list}pushArguments(t){this.key_list=$(t.pop()),this.header_names=$(t.pop()),t.forEach(((e,s)=>{Y(e)?this.address_part=e:":last"===e?this.last=!0:s&&":index"===t[s-1]&&(this.index.value=e.value)}))}},NotTest,class SizeTest extends TestCommand{constructor(){super(),this.mode=":over",this.limit=0}toString(){return"size "+this.mode+" "+this.limit}pushArguments(t){t.forEach((t=>{":over"===t||":under"===t?this.mode=t:t instanceof GrammarNumber&&(this.limit=t)}))}},class TrueTest extends TestCommand{toString(){return"true"}},class BodyTest extends TestCommand{constructor(){super(),this.body_transform="",this.key_list=new GrammarStringList}get require(){return"body"}toString(){return"body"+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.body_transform+" "+this.key_list}pushArguments(t){t.forEach(((e,s)=>{":raw"===e||":text"===e?this.body_transform=e:(e instanceof GrammarStringList||e instanceof GrammarString)&&(s&&":content"===t[s-1]?this.body_transform=":content "+e:this[t[s+1]?"content_list":"key_list"]=e)}))}},class EnvironmentTest extends TestCommand{constructor(){super(),this.name=new GrammarQuotedString,this.key_list=new GrammarStringList}get require(){return"environment"}toString(){return"environment"+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.name+" "+this.key_list}pushArguments(t){this.key_list=t.pop(),this.name=t.pop()}},class SetCommand extends ActionCommand{constructor(){super(),this.modifiers=[],this._name=new GrammarQuotedString,this._value=new GrammarQuotedString}get require(){return"variables"}toString(){return"set "+this.modifiers.join(" ")+" "+this._name+" "+this._value}get name(){return this._name.value}set name(t){this._name.value=t}get value(){return this._value.value}set value(t){this._value.value=t}pushArguments(t){[":lower",":upper",":lowerfirst",":upperfirst",":quotewildcard",":length"].forEach((e=>{t.includes(e)&&this.modifiers.push(e)})),this._value=t.pop(),this._name=t.pop()}},class StringTest extends TestCommand{constructor(){super(),this.source=new GrammarStringList,this.key_list=new GrammarStringList}toString(){return"string "+this.match_type+(this.comparator?" :comparator "+this.comparator:"")+" "+this.source+" "+this.key_list}pushArguments(t){this.key_list=t.pop(),this.source=t.pop()}},class VacationCommand extends ActionCommand{constructor(){super(),this._days=new GrammarNumber,this._seconds=new GrammarNumber,this._subject=new GrammarQuotedString,this._from=new GrammarQuotedString,this.addresses=new GrammarStringList,this.mime=!1,this._handle=new GrammarQuotedString,this._reason=new GrammarQuotedString}get require(){return"vacation"}toString(){let t="vacation";return 0<this._seconds.value&&m.includes("vacation-seconds")?t+=" :seconds "+this._seconds:0<this._days.value&&(t+=" :days "+this._days),this._subject.length&&(t+=" :subject "+this._subject),this._from.length&&(t+=" :from "+this._from),this.addresses.length&&(t+=" :addresses "+this.addresses),this.mime&&(t+=" :mime"),this._handle.length&&(t+=" :handle "+this._handle),t+" "+this._reason}get days(){return this._days.value}get seconds(){return this._seconds.value}get subject(){return this._subject.value}get from(){return this._from.value}get handle(){return this._handle.value}get reason(){return this._reason.value}set days(t){this._days.value=t}set seconds(t){this._seconds.value=t}set subject(t){this._subject.value=t}set from(t){this._from.value=t}set handle(t){this._handle.value=t}set reason(t){this._reason.value=t}pushArguments(t){this._reason.value=t.pop().value,t.forEach(((e,s)=>{":mime"===e?this.mime=!0:s&&":addresses"===t[s-1]?this.addresses=e:s&&":"===t[s-1][0]&&(this[t[s-1].replace(":","_")].value=e.value)}))}},class SetFlagCommand extends FlagCommand{},class AddFlagCommand extends FlagCommand{},class RemoveFlagCommand extends FlagCommand{},class HasFlagTest extends TestCommand{constructor(){super(),this.variable_list=new GrammarStringList,this.list_of_flags=new GrammarStringList}get require(){return"imap4flags"}toString(){return"hasflag "+this.match_type+(this.comparator?" :comparator "+this.comparator:"")+" "+this.variable_list+" "+this.list_of_flags}pushArguments(t){t.forEach(((e,s)=>{(e instanceof GrammarStringList||e instanceof GrammarString)&&(this[t[s+1]?"variable_list":"list_of_flags"]=e)}))}},class SpamTestTest extends TestCommand{constructor(){super(),this.percent=!1,this.value=new GrammarQuotedString}get require(){return/:value|:count/.test(this.match_type)?["spamtestplus","relational"]:"spamtestplus"}toString(){return"spamtest"+(this.percent?" :percent":"")+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.value}pushArguments(t){t.forEach((t=>{":percent"===t?this.percent=!0:t instanceof GrammarString&&(this.value=t)}))}},class VirusTestTest extends TestCommand{constructor(){super(),this.value=new GrammarQuotedString}get require(){return/:value|:count/.test(this.match_type)?["virustest","relational"]:"virustest"}toString(){return"virustest"+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.value}pushArguments(t){t.forEach((t=>{t instanceof GrammarString&&(this.value=t)}))}},class DateTest extends TestCommand{constructor(){super(),this.zone=new GrammarQuotedString,this.originalzone=!1,this.header_name=new GrammarQuotedString,this.date_part=new GrammarQuotedString,this.key_list=new GrammarStringList,this.index=new GrammarNumber,this.last=!1}get require(){return"date"}toString(){return"date"+(this.last?" :last":this.index.value?" :index "+this.index:"")+(this.originalzone?" :originalzone":this.zone.length?" :zone "+this.zone:"")+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.header_name+" "+this.date_part+" "+this.key_list}pushArguments(t){this.key_list=t.pop(),this.date_part=t.pop(),this.header_name=t.pop(),t.forEach(((e,s)=>{":originalzone"===e?this.originalzone=!0:":last"===e?this.last=!0:s&&":zone"===t[s-1]?this.zone.value=e.value:s&&":index"===t[s-1]&&(this.index.value=e.value)}))}},class CurrentDateTest extends TestCommand{constructor(){super(),this.zone=new GrammarQuotedString,this.date_part=new GrammarQuotedString,this.key_list=new GrammarStringList}get require(){return"date"}toString(){return"currentdate"+(this.zone.length?" :zone "+this.zone:"")+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.date_part+" "+this.key_list}pushArguments(t){this.key_list=t.pop(),this.date_part=t.pop(),t.forEach(((e,s)=>{s&&":zone"===t[s-1]&&(this.zone.value=e.value)}))}},class AddHeaderCommand extends ActionCommand{constructor(){super(),this.last=!1,this.field_name=new GrammarQuotedString,this.value=new GrammarQuotedString}get require(){return"editheader"}toString(){return this.identifier+(this.last?" :last":"")+" "+this.field_name+" "+this.value+";"}pushArguments(t){this.value=t.pop(),this.field_name=t.pop(),this.last=t.includes(":last")}},class DeleteHeaderCommand extends ActionCommand{constructor(){super(),this.index=new GrammarNumber,this.last=!1,this.comparator="",this.match_type=":is",this.field_name=new GrammarQuotedString,this.value_patterns=new GrammarStringList}get require(){return"editheader"}toString(){return this.identifier+(this.last?" :last":this.index.value?" :index "+this.index:"")+(this.comparator?" :comparator "+this.comparator:"")+" "+this.match_type+" "+this.field_name+" "+this.value_patterns+";"}pushArguments(t){let e=t.length-1;t.forEach(((e,s)=>{":last"===e?this.last=!0:s&&":index"===t[s-1]&&(this.index.value=e.value,t[s]=null)})),e&&t[e-1]instanceof GrammarString?(this.field_name=t[e-1],this.value_patterns=t[e]):this.field_name=t[e]}},class ErejectCommand extends ActionCommand{constructor(){super(),this._reason=new GrammarQuotedString}get require(){return"ereject"}toString(){return"ereject "+this._reason+";"}get reason(){return this._reason.value}set reason(t){this._reason.value=t}pushArguments(t){t[0]instanceof GrammarString&&(this._reason=t[0])}},class RejectCommand extends ActionCommand{constructor(){super(),this._reason=new GrammarQuotedString}get require(){return"reject"}toString(){return"reject "+this._reason+";"}get reason(){return this._reason.value}set reason(t){this._reason.value=t}pushArguments(t){t[0]instanceof GrammarString&&(this._reason=t[0])}},class NotifyCommand extends ActionCommand{constructor(){super(),this._method=new GrammarQuotedString,this._from=new GrammarQuotedString,this._importance=new GrammarNumber,this.options=new GrammarStringList,this._message=new GrammarQuotedString}get method(){return this._method.value}get from(){return this._from.value}get importance(){return this._importance.value}get message(){return this._message.value}set method(t){this._method.value=t}set from(t){this._from.value=t}set importance(t){this._importance.value=t}set message(t){this._message.value=t}get require(){return"enotify"}toString(){let t="notify";return this._from.value&&(t+=" :from "+this._from),0<this._importance.value&&(t+=" :importance "+this._importance),this.options.length&&(t+=" :options "+this.options),this._message.value&&(t+=" :message "+this._message),t+" "+this._method}pushArguments(t){this._method.value=t.pop().value,t.forEach(((e,s)=>{s&&":options"===t[s-1]?this.options=e:s&&":"===t[s-1][0]&&(this[t[s-1].replace(":","_")].value=e.value)}))}},class ValidNotifyMethodTest extends TestCommand{constructor(){super(),this.notification_uris=new GrammarStringList}toString(){return"valid_notify_method "+this.notification_uris}pushArguments(t){this.notification_uris=t.pop()}},class NotifyMethodCapabilityTest extends TestCommand{constructor(){super(),this.notification_uri=new GrammarQuotedString,this.notification_capability=new GrammarQuotedString,this.key_list=new GrammarStringList}toString(){return"valid_notify_method "+(this.comparator?" :comparator "+this.comparator:"")+(this.match_type?" "+this.match_type:"")+this.notification_uri+this.notification_capability+this.key_list}pushArguments(t){this.key_list=t.pop(),this.notification_capability=t.pop(),this.notification_uri=t.pop()}},class IHaveTest extends TestCommand{constructor(){super(),this.capabilities=new GrammarStringList}get require(){return"ihave"}toString(){return"ihave "+this.capabilities}pushArguments(t){this.capabilities=t.pop()}},class ErrorCommand extends ControlCommand{constructor(){super(),this.message=new GrammarQuotedString}get require(){return"ihave"}toString(){return"error "+this.message+";"}pushArguments(t){this.message=t.pop()}},class MailboxExistsTest extends TestCommand{constructor(){super(),this.mailbox_names=new GrammarStringList}get require(){return"mailbox"}toString(){return"mailboxexists "+this.mailbox_names+";"}pushArguments(t){t[0]instanceof GrammarStringList&&(this.mailbox_names=t[0])}},class MetadataTest extends TestCommand{constructor(){super(),this.mailbox=new GrammarQuotedString,this.annotation_name=new GrammarQuotedString,this.key_list=new GrammarStringList}get require(){return"mboxmetadata"}toString(){return"metadata  "+this.match_type+(this.comparator?" :comparator "+this.comparator:"")+" "+this.mailbox+" "+this.annotation_name+" "+this.key_list}pushArguments(t){this.key_list=t.pop(),this.annotation_name=t.pop(),this.mailbox=t.pop()}},class MetadataExistsTest extends TestCommand{constructor(){super(),this.mailbox=new GrammarQuotedString,this.annotation_names=new GrammarStringList}get require(){return"mboxmetadata"}toString(){return"metadataexists  "+this.mailbox+" "+this.annotation_names}pushArguments(t){this.annotation_names=t.pop(),this.mailbox=t.pop()}},ForEveryPartCommand,class BreakCommand extends ForEveryPartCommand{toString(){let t="break";return this._subject.length&&(t+=" :name "+this._name),t+";"}},class ReplaceCommand extends ActionCommand{constructor(){super(),this.mime=!1,this._subject=new GrammarQuotedString,this._from=new GrammarQuotedString,this.replacement=new GrammarQuotedString}get require(){return"replace"}toString(){let t="replace";return this.mime&&(t+=" :mime"),this._subject.length&&(t+=" :subject "+this._subject),this._from.length&&(t+=" :from "+this._from),t+this.replacement+";"}pushArguments(t){this.replacement=t.pop(),t.forEach(((e,s)=>{":mime"===e?this.mime=!0:s&&":"===t[s-1][0]&&(this[t[s-1].replace(":","_")].value=e.value)}))}},class EncloseCommand extends ActionCommand{constructor(){super(),this._subject=new GrammarQuotedString,this.headers=new GrammarStringList}get require(){return"enclose"}toString(){let t="enclose";return this._subject.length&&(t+=" :subject "+this._subject),this.headers.length&&(t+=" :headers "+this.headers),t+" :text;"}pushArguments(t){t.forEach(((e,s)=>{s&&":"===t[s-1][0]&&(this[t[s-1].replace(":","_")].value=e.value)}))}},class ExtractTextCommand extends ActionCommand{constructor(){super(),this.modifiers=[],this._first=new GrammarNumber,this.varname=new GrammarQuotedString}get require(){return"extracttext"}toString(){let t="extracttext "+this.modifiers.join(" ");return 0<this._first.value&&(t+=" :first "+this._first),t+" "+this.varname+";"}pushArguments(t){this.varname=t.pop(),[":lower",":upper",":lowerfirst",":upperfirst",":quotewildcard",":length"].forEach((e=>{t.includes(e)&&this.modifiers.push(e)})),t.forEach(((e,s)=>{s&&":"===t[s-1][0]&&(this[t[s-1].replace(":","_")].value=e.value)}))}},class IncludeCommand extends ControlCommand{constructor(){super(),this.global=!1,this.once=!1,this.optional=!1,this.value=new GrammarQuotedString}get require(){return"include"}toString(){return"include"+(this.global?" :global":"")+(this.once?" :once":"")+(this.optional?" :optional":"")+" "+this.value+";"}pushArguments(t){t.forEach((t=>{":global"===t||":once"===t||":optional"===t?this[t.slice(1)]=!0:t instanceof GrammarQuotedString&&(this.value=t)}))}},class ReturnCommand extends ControlCommand{get require(){return"include"}},class GlobalCommand extends ControlCommand{constructor(){super(),this.value=new GrammarStringList}get require(){return["include","variables"]}toString(){return"global "+this.value+";"}pushArguments(t){this.value=t.pop()}}],X=()=>{let t,e={};return K.forEach((s=>{t=W(s,ActionCommand),t&&(e[t]=s)})),e},tt=()=>{let t,e={};return K.forEach((s=>{t=W(s,ControlCommand),t&&(e[t]=s)})),e},et=()=>{let t,e={};return K.forEach((s=>{t=W(s,TestCommand),t&&(e[t]=s)})),e},st="("+[B,P,Q,M,"/\\*[\\s\\S]*?\\*/","\\{","\\}","\\(","\\)",",",";",":[a-zA-Z_][a-zA-Z0-9_]*","[a-zA-Z_][a-zA-Z0-9_]*",z,"(?: |\\r\\n|\\t)+","[^ \\r\\n\\t]+"].join(")|(")+")",rt=["","","","","","Block start not part of control command","Block end has no matching block start","Test start not part of anyof/allof test","Test end not part of test-list","Comma not part of test-list","Semicolon not at end of command","","","","",""],it=(t,e="script.sieve")=>{t=t.replace(/\r?\n/g,"\r\n");const s=(()=>{let t,e={};return K.forEach((s=>{t=W(s),t&&(e[t]=s)})),e})();let r,i=1,a=[],n=RegExp(st,"gm"),o=[],m=null,h=[],l=[];const c=s=>{throw new SyntaxError(s+" on line "+i+" around:\n\n"+t.slice(n.lastIndex-20,n.lastIndex+10),e,i)},u=t=>{m||c("Argument not part of command");let e=l[l.length-1];p(0).includes(t)?m.match_type=t:":value"===e||":count"===e?(/^(gt|ge|lt|le|eq|ne)$/.test(t.value)||c("Invalid relational match-type "+t),m.match_type=e+" "+t,--l.length):":comparator"===e?(m.comparator=t,--l.length):l.push(t)},d=()=>{l.length&&(m&&m.pushArguments(l),l=[])};for(o.up=()=>(o.pop(),o[o.length-1]);r=n.exec(t);){let t=r.findIndex(((t,e)=>0<e&&void 0!==t)),e=r[t];switch(t){case 13:{let t;d(),e=e.toLowerCase(),t="if"===e||"elsif"===e||"else"===e?new ConditionalCommand(e):s[e]?new s[e]:m&&(m instanceof ConditionalCommand||m instanceof NotTest||m.tests instanceof GrammarTestList)?new TestCommand(e):new GrammarCommand(e),t instanceof TestCommand?m instanceof ConditionalCommand||m instanceof NotTest?m.test=t:m.tests instanceof GrammarTestList?m.tests.push(t):c('Test "'+e+'" not allowed in "'+m.identifier+'" command'):m?m.commands?m.commands.push(t):c('commands not allowed in "'+m.identifier+'" command'):a.push(t),o.push(t),m=t,m.require&&(Array.isArray(m.require)?m.require:[m.require]).forEach((t=>h.push(t))),m.comparator&&h.push("comparator-"+m.comparator);break}case 12:u(e.toLowerCase());break;case 1:u(GrammarStringList.fromString(e));break;case 3:u(GrammarMultiLine.fromString(e));break;case 2:u(new GrammarQuotedString(e.slice(1,-1)));break;case 14:u(new GrammarNumber(e));break;case 5:case 4:{let s=4==t?new GrammarHashComment(e.slice(1).trim()):new GrammarBracketComment(e.slice(2,-2));m?(m.comments||(m.comments=[]),(m.commands||m.comments).push(s)):a.push(s);break}case 15:m||a.push(e.trim());break;case 11:m||c(rt[t]),d(),m instanceof RequireCommand&&m.capabilities.forEach((t=>h.push(t.value))),m=o.up();break;case 6:for(d();m&&!(m instanceof ConditionalCommand);)m=o.up();m||c(rt[t]);break;case 7:m instanceof ConditionalCommand||c(rt[t]),m=o.up();break;case 8:case 9:case 10:for(d();m&&!(m.tests instanceof GrammarTestList);)m=o.up();m||c(rt[t]);break;case 0:c("Invalid token "+e)}i+=e.split("\n").length-1}return a.requires=h,a};class SieveScriptPopupView extends rl.pluginPopupView{constructor(){super("SieveScript"),this.addObservables({saveError:!1,errorText:"",rawActive:!1,script:null,saving:!1,sieveCapabilities:"",availableActions:"",availableControls:"",availableTests:""}),this.filterForDeletion=ko.observable(null).askDeleteHelper()}validateScript(){try{this.errorText(""),it(this.script().body())}catch(t){this.errorText(t.message)}}saveScript(){let t=this,e=t.script();if(!t.saving()){if(this.errorText(""),t.saveError(!1),!e.verify())return;if(!e.exists()&&h.find((t=>t.name()===e.name())))return void e.nameError(!0);try{it(e.body())}catch(t){return void this.errorText(t.message)}t.saving(!0),e.allowFilters()&&e.body(e.filtersToRaw()),o.request("FiltersScriptSave",((s,r)=>{t.saving(!1),s?(t.saveError(!0),t.errorText(r?.ErrorMessageAdditional||n(s))):(e.exists()||h.push(e),e.exists(!0),e.hasChanges(!1))}),e.toJSON())}}deleteFilter(t){this.script().filters.remove(t)}addFilter(){const t=new FilterModel;t.generateID(),FilterPopupView.showModal([t,()=>this.filters.push(t.assignTo())])}editFilter(t){const e=t.assignTo();FilterPopupView.showModal([e,()=>{e.assignTo(t);const s=this.script();s.hasChanges(s.body()!=s.filtersToRaw())},!0])}toggleFiltersRaw(){const t=this.script(),e=!this.rawActive();e&&t.body(t.filtersToRaw()),this.rawActive(e)}onBuild(t){t.addEventListener("click",(e=>{const s=e.target.closestWithin("td.e-action",t),r=s&&ko.dataFor(s);r&&this.editFilter(r)}))}beforeShow(t){this.sieveCapabilities(m.join(" ")),this.availableActions([...Object.keys(X())].join(", ")),this.availableControls([...Object.keys(tt())].join(", ")),this.availableTests([...Object.keys(et())].join(", ")),t=t||new SieveScriptModel,this.script(t),this.rawActive(!t.allowFilters()),this.saveError(!1),this.errorText("")}}window.Sieve={capa:m,scripts:h,loading:l,serverError:c,serverErrorDesc:u,ScriptView:SieveScriptPopupView,folderList:null,updateList:()=>{l()||(l(!0),c(!1),o.request("Filters",((t,s)=>{l(!1),h([]),t?(m([]),d(n(t))):(m(s.Result.Capa),e(s.Result.Scripts,(t=>{(t=SieveScriptModel.reviveFromJson(t))&&(t.allowFilters()?h.unshift(t):h.push(t))})))})))},deleteScript:t=>{c(!1),o.request("FiltersScriptDelete",((e,s)=>e?d(s?.ErrorMessageAdditional||n(e)):h.remove(t)),{name:t.name()})},setActiveScript(t){c(!1),o.request("FiltersScriptActivate",((e,s)=>e?d(s?.ErrorMessageAdditional||e):h.forEach((e=>e.active(e.name()===t)))),{name:t})}}}();
